def create_advanced_rag_interface():
    """Create advanced RAG interface with professional, well-structured design."""
    
    # No custom CSS; use Gradio defaults
    css = ""
    
    # UI Event Handlers (separate from backend)
    def update_chunk_status(chunk_size, chunk_overlap):
        """Update chunk configuration status display."""
        return f"""
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 10px 0; color: #856404;">
            <strong>üéØ Current Configuration:</strong> chunk_size={chunk_size}, chunk_overlap={chunk_overlap}<br>
            <strong>‚ö†Ô∏è Status:</strong> Configuration changed - click "üöÄ Initialize Database" to apply changes
        </div>
        """
    
    def update_config_display(model, temp, chunk_size, chunk_overlap, top_k, cutoff, postprocessor, synth):
        """Update real-time configuration display."""
        return f"""
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin: 10px 0; color: #155724;">
            <strong>ü§ñ AI Model:</strong> {model} (Temperature: {temp}) &nbsp;&nbsp;
            <strong>üìÑ Chunking:</strong> Size={chunk_size}, Overlap={chunk_overlap}<br>
            <strong>üéØ Retrieval:</strong> Top-K={top_k}, Cutoff={cutoff} &nbsp;&nbsp;
            <strong>üîß Postprocessor:</strong> {'‚úÖ Enabled' if postprocessor else '‚ùå Disabled'} &nbsp;&nbsp;
            <strong>üß† Synthesizer:</strong> {synth}
        </div>
        """
    
    # Backend Interface Handlers
    def initialize_db(chunk_size, chunk_overlap):
        """Handle database initialization with chunk configuration."""
        return rag_backend.initialize_database(chunk_size=int(chunk_size), chunk_overlap=int(chunk_overlap))
    
    def handle_advanced_query(question, model, temperature, chunk_size, chunk_overlap, 
                             similarity_top_k, use_postprocessor, similarity_cutoff, synthesizer):
        """Handle advanced RAG queries with all configuration options."""
        # Convert postprocessor boolean to list format expected by backend
        postprocessors = ["SimilarityPostprocessor"] if use_postprocessor else []
        
        result = rag_backend.advanced_query(
            question, model, temperature, int(chunk_size), int(chunk_overlap),
            int(similarity_top_k), postprocessors, similarity_cutoff, synthesizer
        )
        
        return result["response"]
    
    def clear_inputs():
        """Clear input fields."""
        return "", ""

    # System Configuration popup helpers (match rag_gui style)
    def build_config_html(model, temperature, chunk_size, overlap_size, top_k, similarity_threshold, postprocessor_enabled, synthesizer):
        post_text = "Enabled" if (postprocessor_enabled and len(postprocessor_enabled) > 0) else "Disabled"
        return f"""
        <div id='config_popup_box' style='position: fixed; top: 56px; right: 16px; width: 300px; max-width: 90vw; padding: 10px; border: 1px solid rgba(128,128,128,0.35); border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); z-index: 9999;'>
            <div style='font-weight: 600; margin-bottom: 6px; font-size: 13px;'>System Configuration</div>
            <div style='font-size: 13px; line-height: 1.4;'>
                <div><strong>Model:</strong> {model}</div>
                <div><strong>Temperature:</strong> {temperature}</div>
                <div><strong>Chunk Size:</strong> {int(chunk_size)}</div>
                <div><strong>Overlap:</strong> {int(overlap_size)}</div>
                <div><strong>Top-K:</strong> {int(top_k)}</div>
                <div><strong>Similarity Threshold:</strong> {similarity_threshold}</div>
                <div><strong>Postprocessor:</strong> {post_text}</div>
                <div><strong>Synthesizer:</strong> {synthesizer}</div>
            </div>
        </div>
        """

    def toggle_config(is_visible, model, temperature, chunk_size, overlap_size, top_k, similarity_threshold, postprocessor_enabled, synthesizer):
        new_visible = not bool(is_visible)
        html = build_config_html(model, temperature, chunk_size, overlap_size, top_k, similarity_threshold, postprocessor_enabled, synthesizer)
        return gr.update(value=html, visible=new_visible), new_visible, gr.update(visible=new_visible)
    
    # Create the Gradio Interface
    with gr.Blocks(css=css, title="üöÄ Advanced RAG System - A3b") as interface:
        # Header Section
        gr.HTML("""
        <div class="main-container">
            <h1 style="text-align: center; color: #2c3e50; margin-bottom: 10px; font-size: 2.5em;">
                ÔøΩ Advanced RAG System (Assignment 3B)
            </h1>
            <p style="text-align: center; color: #7f8c8d; font-size: 18px; margin-bottom: 30px;">
                Professional-grade Retrieval-Augmented Generation with full configurability
            </p>
        </div>
        """)
        
        # System Configuration toggle and popup
        with gr.Row():
            with gr.Column(scale=5):
                pass
            with gr.Column(scale=1):
                config_button = gr.Button("System Configuration", variant="secondary", size="sm", elem_id="config_toggle_btn_a3b")
        config_popup = gr.HTML(value="", visible=False)
        config_visible = gr.State(False)
        close_config_button = gr.Button("√ó", variant="secondary", size="sm", visible=False, elem_id="config_close_btn_a3b")

        gr.HTML("""
        <style>
        #config_popup_box { background: #ffffff; color: #222; }
        @media (prefers-color-scheme: dark) {
          #config_popup_box { background: #2b2b2b; color: #f2f2f2; border-color: rgba(255,255,255,0.25); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
        }
        #config_toggle_btn_a3b { width: auto !important; display: inline-block; }
        #config_toggle_btn_a3b button { font-size: 12px; padding: 2px 8px; min-height: 26px; width: auto !important; min-width: 0 !important; display: inline-flex; }
        #config_close_btn_a3b { position: fixed; top: 15px; right: 12px; z-index: 10000; width: auto !important; }
        #config_close_btn_a3b button { font-size: 14px; padding: 2px 8px; min-height: 26px; width: auto !important; min-width: 0 !important; display: inline-flex; }
        </style>
        """)
        
        # API Status Display
        api_status = gr.HTML(get_api_status_html())

        # Top output display and question row (align with rag_gui)
        response_output = gr.Textbox(label="", value="Welcome! Enter your question below to get AI-powered insights from your documents.", lines=8, max_lines=12, interactive=False, show_label=False)
        with gr.Row():
            query_input = gr.Textbox(label="", placeholder="Ask your question here...", lines=1, scale=4, show_label=False)
            submit_btn = gr.Button("Submit", variant="primary", size="lg", scale=1)

        # Database Initialization Section
        gr.Markdown("### üìÅ Database Setup")
        with gr.Row():
            init_btn = gr.Button("üîÑ Initialize Vector Database", variant="primary", scale=1)
            status_output = gr.Textbox(
                label="Initialization Status", 
                value="Click 'Initialize Vector Database' to get started...",
                interactive=False,
                scale=2
            )
        
        # Main layout with columns
        with gr.Row():
            with gr.Column(scale=1):
                gr.Markdown("### ‚öôÔ∏è RAG Configuration")
                
                # Model selection
                model_dropdown = gr.Dropdown(
                    choices=["gpt-4o", "gpt-4o-mini"],
                    value="gpt-4o-mini",
                    label="ü§ñ Language Model",
                    info="Choose your preferred model"
                )
                
                # Temperature control  
                temperature_slider = gr.Slider(
                    minimum=0.0,
                    maximum=1.0,
                    step=0.1,
                    value=0.1,
                    label="üå°Ô∏è Temperature",
                    info="Lower = more focused, Higher = more creative"
                )
                
                # Chunking parameters
                with gr.Row():
                    chunk_size_input = gr.Number(
                        value=512,
                        minimum=128,
                        maximum=2048,
                        step=64,
                        label="üìÑ Chunk Size",
                        info="Text chunk size for processing"
                    )
                    
                    chunk_overlap_input = gr.Number(
                        value=50,
                        minimum=0,
                        maximum=200,
                        step=10,
                        label="üîó Chunk Overlap",
                        info="Overlap between chunks"
                    )
                
                # Retrieval parameters
                similarity_topk_slider = gr.Slider(
                    minimum=1,
                    maximum=20,
                    step=1,
                    value=5,
                    label="üéØ Similarity Top-K",
                    info="Number of similar documents to retrieve"
                )
                
                # Postprocessor selection
                postprocessor_checkbox = gr.CheckboxGroup(
                    choices=["SimilarityPostprocessor"],
                    value=[],
                    label="üîß Node Postprocessors",
                    info="Additional result filtering"
                )
                
                # Similarity filtering
                similarity_cutoff_slider = gr.Slider(
                    minimum=0.0,
                    maximum=1.0,
                    step=0.1,
                    value=0.3,
                    label="‚úÇÔ∏è Similarity Cutoff",
                    info="Minimum similarity score threshold"
                )
                
                # Response synthesizer
                synthesizer_dropdown = gr.Dropdown(
                    choices=["TreeSummarize", "Refine", "CompactAndRefine", "Default"],
                    value="Default",
                    label="üß† Response Synthesizer",
                    info="How to combine retrieved information"
                )
            
            with gr.Column(scale=2):
                gr.Markdown("### üí¨ Query Interface")
                
                # Query input
                query_input2 = gr.Textbox(
                    label="‚ùì Ask a question",
                    placeholder="Enter your question here... (e.g., 'What are AI agents and their capabilities?')",
                    lines=3
                )
                
                # Submit button
                submit_btn2 = gr.Button(
                    "üöÄ Ask Question", 
                    variant="primary",
                    size="lg"
                )
                
                # Response output
                response_output2 = gr.Textbox(
                    label="ü§ñ AI Response",
                    lines=12,
                    interactive=False,
                    placeholder="AI response will appear here..."
                )
                
                # Configuration display
                config_display_hidden = gr.Textbox(visible=False,
                    label="üìã Current Configuration",
                    lines=8,
                    interactive=False,
                    placeholder="Configuration details will appear here..."
                )
        
        # Connect functions to components
        init_btn.click(
            initialize_db, 
            inputs=[chunk_size_input, chunk_overlap_input],
            outputs=[status_output]
        )
        
        submit_btn.click(
            handle_advanced_query,
            inputs=[
                query_input, model_dropdown, temperature_slider,
                chunk_size_input, chunk_overlap_input, similarity_topk_slider,
                postprocessor_checkbox, similarity_cutoff_slider, synthesizer_dropdown
            ],
            outputs=[response_output]
        )

        # Toggle System Configuration popup
        config_button.click(
            fn=toggle_config,
            inputs=[
                config_visible,
                model_dropdown,
                temperature_slider,
                chunk_size_input,
                chunk_overlap_input,
                similarity_topk_slider,
                similarity_cutoff_slider,
                postprocessor_checkbox,
                synthesizer_dropdown,
            ],
            outputs=[config_popup, config_visible, close_config_button]
        )
        close_config_button.click(
            fn=toggle_config,
            inputs=[
                config_visible,
                model_dropdown,
                temperature_slider,
                chunk_size_input,
                chunk_overlap_input,
                similarity_topk_slider,
                similarity_cutoff_slider,
                postprocessor_checkbox,
                synthesizer_dropdown,
            ],
            outputs=[config_popup, config_visible, close_config_button]
        )
    
    return interface


